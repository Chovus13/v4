<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PsyBot Control Panel</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        header {
            background-color: #333;
            color: white;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        header h1 {
            margin: 0;
            font-size: 24px;
        }
        #latency {
            font-size: 14px;
        }
        .container {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .controls button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .controls button:hover {
            background-color: #0056b3;
        }
        .status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .status div {
            font-size: 16px;
        }
        .chart-container {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            height: 300px;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .tabs button {
            padding: 10px;
            background-color: #ddd;
            border: none;
            border-radius: 5px 5px 0 0;
            cursor: pointer;
        }
        .tabs button.active {
            background-color: #007bff;
            color: white;
        }
        .tab-content {
            background-color: white;
            padding: 20px;
            border-radius: 0 5px 5px 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            max-height: 200px;
            overflow-y: auto;
        }
        footer {
            background-color: #333;
            color: white;
            padding: 10px;
            text-align: center;
            font-size: 14px;
        }
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            .status {
                grid-template-columns: 1fr;
            }
            .chart-container {
                height: 200px;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>PsyBot Control Panel</h1>
        <div id="latency">Latency: REST: N/A ms | WS: N/A ms</div>
    </header>
    <div class="container">
        <div class="controls">
            <button onclick="startTrading()">Start Trading</button>
            <button onclick="stopTrading()">Stop Trading</button>
            <button onclick="manualMode('on')">Uključi Manuelni Režim</button>
            <button onclick="manualMode('off')">Isključi Manuelni Režim</button>
            <button onclick="disableTpSl()">Isključi TP/SL</button>
            <button onclick="closePosition()">Zatvori Poziciju</button>
            <button onclick="setRokada('on')">Rokada On</button>
            <button onclick="setRokada('off')">Rokada Off</button>
            <button onclick="toggleRsi('on')">RSI On</button>
            <button onclick="toggleRsi('off')">RSI Off</button>
        </div>
        <div class="status">
            <div>Price: <span id="price">N/A</span> ETH/BTC</div>
            <div>Support: <span id="support">0</span></div>
            <div>Resistance: <span id="resistance">0</span></div>
            <div>Trend: <span id="trend">N/A</span></div>
            <div>Position: <span id="position">None</span></div>
            <div>Balance: <span id="balance">N/A</span> USDT</div>
            <div>Unrealized MMR: <span id="unimmr">0</span></div>
            <div>Manual Mode: <span id="manual">off</span></div>
            <div>Rokada Strategy: <span id="rokada">off</span></div>
            <div>RSI (5m): <span id="rsi">N/A</span></div>
            <div>Trade Amount (ETH): <span id="tradeAmount">0.01</span></div>
            <div>Leverage (x): <span id="leverage">3</span></div>
            <div>Support Speed: <span id="supportSpeed">0</span></div>
            <div>Resistance Speed: <span id="resistanceSpeed">0</span></div>
            <div>CPU: <span id="cpuPercent">N/A</span>%</div>
            <div>Memory: <span id="memoryPercent">N/A</span>%</div>
        </div>
        <div id="wallsInfo" style="margin-top: 10px;">
            <p>Support Prices: <span id="supportPrices">N/A</span></p>
            <p>Resistance Prices: <span id="resistancePrices">N/A</span></p>
        </div>
        <div class="chart-container">
            <canvas id="orderbookChart"></canvas>
        </div>
        <div class="tabs">
            <button class="active" onclick="showTab('signals')">Signals</button>
            <button onclick="showTab('activeTrades')">Active Trades</button>
            <button onclick="showTab('tradeAttempts')">Trade Attempts</button>
        </div>
        <div class="tab-content" id="signals">
            <p>Nema signala</p>
        </div>
        <div class="tab-content" id="activeTrades" style="display: none;">
            <p>Nema aktivnih trejdova</p>
        </div>
        <div class="tab-content" id="tradeAttempts" style="display: none;">
            <p>Nema pokušaja trejda</p>
        </div>
    </div>
    <footer>
        <p>Bot Status: <span id="botStatus">Disconnected</span> | Latest Signal: <span id="latestSignal">N/A</span></p>
    </footer>

    <script>
        let ws = null;
        let chart = null;
        let lastRestPing = 0;
        let lastWsPing = 0;
        let lastWsPong = 0;

        // Inicijalizacija WebSocket-a
        function connectWebSocket() {
            ws = new WebSocket('ws://' + window.location.host + '/ws');
            ws.onopen = () => {
                console.log('WebSocket connected');
                document.getElementById('botStatus').textContent = 'Connected';
                lastWsPing = Date.now();
            };
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'ping') {
                    lastWsPing = Date.now();
                } else if (data.type === 'data') {
                    lastWsPong = Date.now();
                    updateUI(data);
                    updateChart(data);
                    updateLatency();
                }
            };
            ws.onclose = () => {
                console.log('WebSocket disconnected');
                document.getElementById('botStatus').textContent = 'Disconnected';
                setTimeout(connectWebSocket, 5000);
            };
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }

        // Inicijalizacija Chart.js grafika
        function initChart() {
            const ctx = document.getElementById('orderbookChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'Support',
                            data: [],
                            borderColor: 'green',
                            fill: false,
                            stepped: true,
                        },
                        {
                            label: 'Resistance',
                            data: [],
                            borderColor: 'red',
                            fill: false,
                            stepped: true,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: { display: true, text: 'Price (ETH/BTC)' }
                        },
                        y: {
                            title: { display: true, text: 'Volume' }
                        }
                    }
                }
            });
        }

        // Ažuriranje UI-a
        function updateUI(data) {
            document.getElementById('price').textContent = data.price || 'N/A';
            document.getElementById('support').textContent = data.support || 0;
            document.getElementById('resistance').textContent = data.resistance || 0;
            document.getElementById('trend').textContent = data.trend || 'N/A';
            document.getElementById('position').textContent = data.position || 'None';
            document.getElementById('balance').textContent = data.balance || 'N/A';
            document.getElementById('unimmr').textContent = data.unimmr || 0;
            document.getElementById('manual').textContent = data.manual || 'off';
            document.getElementById('rokada').textContent = data.rokada_status || 'off';
            document.getElementById('rsi').textContent = data.rsi || 'N/A';
            document.getElementById('tradeAmount').textContent = data.trade_amount || 0.05;
            document.getElementById('leverage').textContent = data.leverage || 2;
            document.getElementById('supportSpeed').textContent = data.wall_movement?.support_speed.toFixed(5) || 0;
            document.getElementById('resistanceSpeed').textContent = data.wall_movement?.resistance_speed.toFixed(5) || 0;
            document.getElementById('cpuPercent').textContent = data.system_stats?.cpu_percent.toFixed(1) || 'N/A';
            document.getElementById('memoryPercent').textContent = data.system_stats?.memory_percent.toFixed(1) || 'N/A';



    // Ostali deo funkcije ostaje isti...


            // Ažuriranje signala
            const signalsDiv = document.getElementById('signals');
            if (data.signals && data.signals.length > 0) {
                signalsDiv.innerHTML = data.signals.map((signal, index) => `
                    <p>Signal ${index + 1}: ${signal.type} | Entry: ${signal.entry_price} | SL: ${signal.stop_loss} | TP: ${signal.take_profit} | Wall: ${signal.wall_type} | Volume: ${signal.volume}
                    <button onclick="startTrade(${index})">Start Trade</button></p>
                `).join('');
                // Ažuriranje najjačeg signala u footer-u
                const strongestSignal = data.signals[0];
                document.getElementById('latestSignal').textContent = `${strongestSignal.type} | Entry: ${strongestSignal.entry_price} | Volume: ${strongestSignal.volume}`;
            } else {
                signalsDiv.innerHTML = '<p>Nema signala</p>';
                document.getElementById('latestSignal').textContent = 'N/A';
            }

            // Ažuriranje aktivnih trejdova
            const activeTradesDiv = document.getElementById('activeTrades');
            if (data.active_trades && data.active_trades.length > 0) {
                activeTradesDiv.innerHTML = data.active_trades.map(trade => `
                    <p>Type: ${trade.type} | Entry: ${trade.entry_price} | Current: ${trade.current_price} | Status: ${trade.status}</p>
                `).join('');
            } else {
                activeTradesDiv.innerHTML = '<p>Nema aktivnih trejdova</p>';
            }

            // Ažuriranje pokušaja trejdova
            const tradeAttemptsDiv = document.getElementById('tradeAttempts');
            if (data.trade_attempts && data.trade_attempts.length > 0) {
                tradeAttemptsDiv.innerHTML = data.trade_attempts.map(attempt => `
                    <p>Attempt: ${attempt}</p>
                `).join('');
            } else {
                tradeAttemptsDiv.innerHTML = '<p>Nema pokušaja trejda</p>';
            }
        }

        // Ažuriranje grafika
        function updateChart(data) {
            const supportData = data.support_walls ? data.support_walls.map(wall => ({ x: wall[0], y: wall[1] })) : [];
            const resistanceData = data.resistance_walls ? data.resistance_walls.map(wall => ({ x: wall[0], y: wall[1] })) : [];
            chart.data.datasets[0].data = supportData;
            chart.data.datasets[1].data = resistanceData;
            chart.update();

            // Ažuriranje cena Support-a i Resistance-a
            document.getElementById('supportPrices').textContent = supportData.length > 0 ? supportData.map(d => d.x).join(', ') : 'N/A';
            document.getElementById('resistancePrices').textContent = resistanceData.length > 0 ? resistanceData.map(d => d.x).join(', ') : 'N/A';
        }

        // Ažuriranje latency-a
        async function updateLatency() {
            // REST API ping
            const startRest = Date.now();
            await fetch('/get_data');
            lastRestPing = Date.now() - startRest;

            // WebSocket latency
            const wsLatency = lastWsPong - lastWsPing;

            document.getElementById('latency').textContent = `Latency: REST: ${lastRestPing} ms | WS: ${wsLatency} ms`;
        }

        // Funkcije za dugmad
        async function startTrading() {
            alert('Starting trading...');
            // Dodaj logiku za automatsko pokretanje trejdova ako je potrebno
        }

        async function stopTrading() {
            alert('Stopping trading...');
            // Dodaj logiku za zaustavljanje trejdova
        }

        async function startTrade(signalIndex) {
            const response = await fetch(`/start_trade/${signalIndex}`);
            const result = await response.json();
            if (result.error) {
                alert(`Greška: ${result.error}`);
            } else {
                alert('Trejd započet!');
            }
        }

        async function manualMode(status) {
            const response = await fetch(`/set_manual/${status}`);
            const result = await response.json();
            if (result.error) {
                alert(`Greška: ${result.error}`);
            } else {
                document.getElementById('manual').textContent = status;
            }
        }

        async function disableTpSl() {
            alert('TP/SL isključen');
            // Dodaj logiku za isključivanje TP/SL
        }

        async function closePosition() {
            alert('Pozicija zatvorena');
            // Dodaj logiku za zatvaranje pozicije
        }

        async function setRokada(status) {
            const response = await fetch(`/set_rokada/${status}`);
            const result = await response.json();
            if (result.error) {
                alert(`Greška: ${result.error}`);
            } else {
                document.getElementById('rokada').textContent = status;
            }
        }

        async function toggleRsi(status) {
            document.getElementById('rsi').textContent = status === 'on' ? '50' : 'N/A';
            // Dodaj logiku za uključivanje/isključivanje RSI-a
        }

        // Funkcija za tabove
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
            document.querySelectorAll('.tabs button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabId).style.display = 'block';
            document.querySelector(`button[onclick="showTab('${tabId}')"]`).classList.add('active');
        }

        // Inicijalizacija
        window.onload = () => {
            connectWebSocket();
            initChart();
            setInterval(updateLatency, 5000); // Ažuriraj latency svakih 5 sekundi
        };
    </script>
</body>
</html>